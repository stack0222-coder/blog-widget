<script>
  document.addEventListener("DOMContentLoaded", function () {
    var BLOG_ID = "stack0222";   // 네이버 블로그 아이디
    var SHOW_COUNT = 4;          // 보여줄 글 개수

    // Cloudflare Worker 기본 주소 (본인 것)
    var WORKER_BASE = "https://purple-rice-7b4d.stack0222.workers.dev";

    // RSS 프록시 주소
    var rssProxyUrl = WORKER_BASE + "/rss?blogId=" + BLOG_ID;

    // 디버그: 요청 URL을 콘솔과 화면에 찍어보기
    console.log("RSS Proxy URL:", rssProxyUrl);
    var loadingEl = document.getElementById("loading");
    if (loadingEl) {
      loadingEl.innerText = "RSS 불러오는 중...\n" + rssProxyUrl;
    }

    // XML <item> 안에서 특정 태그 텍스트 뽑기
    function getTagText(item, tagName) {
      var el = item.getElementsByTagName(tagName)[0];
      return el ? (el.textContent || "") : "";
    }

    // description 안에서 첫 번째 이미지 src 추출 후 /img 프록시로 감싸기
    function getThumbnailUrl(item) {
      var descHtml = getTagText(item, "description");
      if (!descHtml) return "";

      // HTML 엔티티 복원 (&amp; -> &)
      descHtml = descHtml.replace(/&amp;/g, "&");

      var m = descHtml.match(/<img[^>]+src=['"]([^'">]+)['"]/i);
      if (!m || !m[1]) return "";

      var rawUrl = m[1];
      return WORKER_BASE + "/img?url=" + encodeURIComponent(rawUrl);
    }

    // RSS XML 가져오기
    fetch(rssProxyUrl)
      .then(function (res) {
        // HTTP 상태 코드 체크
        if (!res.ok) {
          throw new Error("HTTP 상태 " + res.status);
        }
        return res.text();
      })
      .then(function (xmlText) {
        console.log("받은 XML 길이:", xmlText.length);

        var parser = new DOMParser();
        var xml = parser.parseFromString(xmlText, "application/xml");

        var items = xml.getElementsByTagName("item");
        var list = document.querySelector(".blog-list");
        var loadingEl = document.getElementById("loading");

        if (loadingEl) loadingEl.style.display = "none";

        if (!items || items.length === 0) {
          if (list) {
            list.innerHTML =
              '<li style="text-align:center;">글을 불러올 수 없습니다. (item 0개)</li>';
          }
          return;
        }

        console.log("RSS item 개수:", items.length);

        var count = Math.min(items.length, SHOW_COUNT);

        for (var i = 0; i < count; i++) {
          var item = items[i];
          var li = document.createElement("li");

          var title    = getTagText(item, "title");
          var link     = getTagText(item, "link");
          var pubDate  = getTagText(item, "pubDate");
          var descHtml = getTagText(item, "description");

          // 본문 요약: HTML 태그 제거 후 100자
          var cleanDesc = descHtml
            .replace(/&lt;/g, "<")
            .replace(/&gt;/g, ">")
            .replace(/&amp;/g, "&")
            .replace(/<[^>]*>/g, "")
            .slice(0, 100) + "...";

          var date = pubDate ? pubDate.split(" ")[0] : "";

          var thumbUrl = getThumbnailUrl(item);
          var thumbHTML = "";
          if (thumbUrl) {
            thumbHTML =
              '<div class="thumb">' +
                '<img src="' + thumbUrl + '" alt="' + (title || "") + ' 썸네일">' +
              '</div>';
          }

          li.innerHTML =
            thumbHTML +
            '<a href="' + link + '" target="_blank" rel="noopener">' +
              title +
            '</a>' +
            '<div class="desc">' + cleanDesc + '</div>' +
            '<div class="date">' + date + '</div>';

          list.appendChild(li);
        }

        // 아임웹 iframe 높이 자동 조절
        setTimeout(function () {
          var height = document.body.scrollHeight;
          if (window.parent) {
            window.parent.postMessage(
              { type: "resize", height: height },
              "*"
            );
          }
        }, 300);
      })
      .catch(function (err) {
        var loadingEl = document.getElementById("loading");
        if (loadingEl) {
          loadingEl.innerText = "불러오기 실패: " + err;
        }

        // 화면 아래쪽에 디버그 메시지도 같이 표시
        var debug = document.createElement("div");
        debug.style.color = "red";
        debug.style.fontSize = "12px";
        debug.style.marginTop = "10px";
        debug.textContent = "DEBUG: " + err;
        document.body.appendChild(debug);

        console.error("fetch 에러:", err);
      });
  });
</script>
