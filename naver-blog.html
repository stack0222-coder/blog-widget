<script>
  // 페이지의 HTML이 모두 준비된 후 실행
  document.addEventListener("DOMContentLoaded", function () {

    // [A] 기본 설정 -------------------------------
    // ▶ 네이버 블로그 아이디
    const BLOG_ID = "stack0222";   // ← 본인 블로그 아이디로 변경 가능

    // ▶ 한 번에 보여줄 글 개수
    const SHOW_COUNT = 5;

    // [B] RSS / API 주소 만들기 --------------------
    const rssUrl = "https://rss.blog.naver.com/" + BLOG_ID + ".xml";
    const apiUrl =
      "https://api.rss2json.com/v1/api.json?rss_url=" + encodeURIComponent(rssUrl);

    // [C] 썸네일 이미지 URL 추출 함수 --------------
    function getThumbnail(item) {
      // 1) rss2json이 제공하는 thumbnail 필드가 있으면 우선 사용
      if (item.thumbnail) {
        return item.thumbnail;
      }

      // 2) enclosure에 이미지 링크가 있으면 사용
      if (item.enclosure && item.enclosure.link) {
        return item.enclosure.link;
      }

      // 3) description 또는 content 안에서 <img src="..."> 또는 <img src='...'> 찾기
      var html = item.description || item.content || "";

      // " 또는 ' 모두 대응하는 정규식
      var matchImg = html.match(/<img[^>]+src=['"]([^'">]+)['"]/i);
      if (matchImg && matchImg[1]) {
        return matchImg[1];
      }

      // 4) 혹시 태그가 깨져 있어도, 네이버 이미지 도메인 URL만이라도 찾기
      var matchNaver = html.match(/https?:\/\/blogfiles\.naver\.net\/[^\s'"]+/i);
      if (matchNaver && matchNaver[0]) {
        return matchNaver[0];
      }

      // 5) 아무 것도 못 찾으면 빈 문자열 (이미지 없음 처리)
      return "";
    }

    // [D] 실제로 데이터 가져오기 --------------------
    fetch(apiUrl)
      .then(function (res) {
        return res.json();
      })
      .then(function (data) {
        var list = document.querySelector(".blog-list");
        var loadingEl = document.getElementById("loading");

        // 로딩 문구 숨기기
        if (loadingEl) loadingEl.style.display = "none";

        // 데이터가 없거나 에러가 난 경우
        if (!data || data.status !== "ok" || !data.items) {
          if (list) {
            list.innerHTML =
              '<li style="text-align:center;">글을 불러올 수 없습니다.</li>';
          }
          return;
        }

        // [E] 글 목록 생성 --------------------------
        data.items.slice(0, SHOW_COUNT).forEach(function (item) {
          var li = document.createElement("li");

          // 날짜 (예: 2024-02-01 형식)
          var date = item.pubDate ? item.pubDate.split(" ")[0] : "";

          // 본문 요약 (HTML 태그 제거 후 앞 100글자)
          var rawDesc = item.description || "";
          var cleanDesc =
            rawDesc.replace(/<[^>]*>/g, "").slice(0, 100) + "...";

          // 썸네일 URL 추출
          var thumbUrl = getThumbnail(item);

          // 썸네일 HTML (이미지가 있을 때만 출력)
          var thumbHTML = "";
          if (thumbUrl) {
            thumbHTML =
              '<div class="thumb">' +
                '<img src="' + thumbUrl + '" alt="' + (item.title || "") + ' 썸네일">' +
              '</div>';
          }

          // li 안에 들어갈 전체 HTML 구조
          li.innerHTML =
            thumbHTML +
            '<a href="' + item.link + '" target="_blank" rel="noopener">' +
              item.title +
            '</a>' +
            '<div class="desc">' + cleanDesc + '</div>' +
            '<div class="date">' + date + '</div>';

          list.appendChild(li);
        });

        // [F] (선택 기능) iframe 높이를 부모 페이지에 알려주기
        setTimeout(function () {
          var height = document.body.scrollHeight;
          if (window.parent) {
            window.parent.postMessage(
              { type: "resize", height: height },
              "*"
            );
          }
        }, 300);
      })
      .catch(function () {
        // 네트워크 에러 / API 호출 실패 시
        var loadingEl = document.getElementById("loading");
        if (loadingEl) loadingEl.innerText = "불러오기 실패";
      });
  });
</script>
