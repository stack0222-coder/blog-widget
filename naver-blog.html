<script>
document.addEventListener("DOMContentLoaded", function () {

  // [A] 기본 설정
  const BLOG_ID = "stack0222";   // ← 네이버 블로그 아이디
  const SHOW_COUNT = 5;          // ← 보여줄 글 개수

  // [B] RSS / API 주소
  const rssUrl = "https://rss.blog.naver.com/" + BLOG_ID + ".xml";
  const apiUrl =
    "https://api.rss2json.com/v1/api.json?rss_url=" + encodeURIComponent(rssUrl);

  // [C] 썸네일 URL 보정 함수
  function normalizeThumbnailUrl(url) {
    if (!url) return "";

    // 1) http → https 강제 변경
    url = url.replace(/^http:\/\//i, "https://");

    // 2) blogthumb → blogfiles 로 변경 + ?뒤 파라미터 제거
    if (url.indexOf("blogthumb.pstatic.net") !== -1) {
      url = url.replace("blogthumb.pstatic.net", "blogfiles.pstatic.net");
      var qIndex = url.indexOf("?");
      if (qIndex !== -1) {
        url = url.substring(0, qIndex); // ? 뒤는 잘라냄
      }
    }

    return url;
  }

  // [D] 썸네일 이미지 URL 추출 함수
  function getThumbnail(item) {
    var url = "";

    // 1) rss2json thumbnail 필드
    if (item.thumbnail) {
      url = item.thumbnail;
    }
    // 2) enclosure 에서 찾기
    else if (item.enclosure && (item.enclosure.link || item.enclosure.url)) {
      url = item.enclosure.link || item.enclosure.url;
    }
    // 3) description / content 안의 <img src="..."> / <img src='...'>
    else {
      var html = item.description || item.content || "";

      var m = html.match(/<img[^>]+src=['"]([^'">]+)['"]/i);
      if (m && m[1]) {
        url = m[1];
      } else {
        // 4) blogfiles.naver.net 형태의 URL만이라도 잡기
        var m2 = html.match(/https?:\/\/blogfiles\.naver\.net\/[^\s'"]+/i);
        if (m2 && m2[0]) {
          url = m2[0];
        }
      }
    }

    return normalizeThumbnailUrl(url);
  }

  // [E] 실제 데이터 가져오기
  fetch(apiUrl)
    .then(function (res) {
      return res.json();
    })
    .then(function (data) {
      var list = document.querySelector(".blog-list");
      var loadingEl = document.getElementById("loading");

      // 로딩 문구 숨기기
      if (loadingEl) loadingEl.style.display = "none";

      // 데이터가 없거나 에러일 때
      if (!data || data.status !== "ok" || !data.items) {
        if (list) {
          list.innerHTML =
            '<li style="text-align:center;">글을 불러올 수 없습니다.</li>';
        }
        return;
      }

      // [F] 글 목록 생성
      data.items.slice(0, SHOW_COUNT).forEach(function (item) {
        var li = document.createElement("li");

        // 날짜 (예: 2026-02-01 형식)
        var date = item.pubDate ? item.pubDate.split(" ")[0] : "";

        // 본문 요약 (HTML 태그 제거 후 앞 100글자)
        var rawDesc = item.description || "";
        var cleanDesc =
          rawDesc.replace(/<[^>]*>/g, "").slice(0, 100) + "...";

        // 썸네일 URL 추출 + 보정
        var thumbUrl = getThumbnail(item);
        var thumbHTML = "";

        if (thumbUrl) {
          thumbHTML =
            '<div class="thumb">' +
              '<img src="' + thumbUrl + '" ' +
                   'alt="' + (item.title || "") + ' 썸네일" ' +
                   'referrerpolicy="no-referrer">' +  // ★ referer 안 보내기
            '</div>';
        }

        // li 안에 들어갈 전체 HTML
        li.innerHTML =
          thumbHTML +
          '<a href="' + item.link + '" target="_blank" rel="noopener">' +
            item.title +
          '</a>' +
          '<div class="desc">' + cleanDesc + '</div>' +
          '<div class="date">' + date + '</div>';

        list.appendChild(li);
      });

      // [G] (선택) 부모 iframe 높이 자동 조절
      setTimeout(function () {
        var height = document.body.scrollHeight;
        if (window.parent) {
          window.parent.postMessage(
            { type: "resize", height: height },
            "*"
          );
        }
      }, 300);
    })
    .catch(function (err) {
      var loadingEl = document.getElementById("loading");
      if (loadingEl) loadingEl.innerText = "불러오기 실패";
      console.error(err);
    });
});
</script>


